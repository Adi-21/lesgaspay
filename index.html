<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI NFT Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f3f4f6;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #6366f1;
        }

        .preview-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px dashed #e5e7eb;
            background: #f8fafc;
        }

        .loading {
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }
    </style>
</head>

<body class="min-h-screen pb-8">
    <nav class="gradient-bg text-white p-4 mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">AI NFT Creator</h1>
            <div id="walletInfo" class="text-sm"></div>
        </div>
    </nav>

    <main class="container mx-auto px-4 max-w-4xl">
        <!-- Wallet Setup -->
        <div class="card" id="walletSetup">
            <h2 class="text-xl font-bold mb-4">üîê Wallet Setup</h2>
            <div class="flex gap-4 flex-wrap">
                <button onclick="createNewWallet()" id="createWalletBtn" class="btn-primary">
                    Create New Wallet
                </button>
                <button onclick="importWallet()" id="importWalletBtn" class="btn-primary">
                    Import Wallet
                </button>
            </div>
            <input type="text" id="privateKey" placeholder="Enter your private key (with 0x prefix)"
                class="input-field mt-4" style="display: none;">
            <div id="walletDetails" class="mt-4 text-sm text-gray-600"></div>
        </div>

        <!-- Smart Account Setup -->
        <div class="card" id="smartAccountSetup">
            <h2 class="text-xl font-bold mb-4">üîë Smart Account Setup</h2>
            <button onclick="setupSmartAccount()" id="setupBtn" disabled class="btn-primary w-full">
                Setup Smart Account
            </button>
            <div id="smartAccountInfo" class="mt-4 text-sm text-gray-600"></div>
        </div>

        <!-- NFT Creation -->
        <div class="card" id="nftCreation">
            <h2 class="text-xl font-bold mb-4">üé® Create AI-Generated NFT</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <textarea id="promptInput" placeholder="Describe your NFT artwork in detail..." class="input-field"
                        rows="4"></textarea>
                    <select id="styleSelect" class="input-field">
                        <option value="realistic">Realistic Photography</option>
                        <option value="abstract">Abstract Art</option>
                        <option value="digital">Digital Art</option>
                        <option value="3d">3D Render</option>
                        <option value="pixel">Pixel Art</option>
                        <option value="cartoon">Cartoon Style</option>
                    </select>
                    <button onclick="generateArtwork()" id="generateBtn" class="btn-primary w-full">
                        Generate Artwork
                    </button>
                </div>
                <div>
                    <img id="artworkPreview" class="preview-image"
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f8fafc'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='Arial' font-size='14' fill='%2394a3b8'%3EArtwork preview will appear here%3C/text%3E%3C/svg%3E"
                        alt="Artwork preview">
                </div>
            </div>
        </div>

        <!-- NFT Details -->
        <div class="card" id="nftDetails">
            <h2 class="text-xl font-bold mb-4">üìù NFT Details</h2>
            <input type="text" id="nftName" placeholder="NFT Name" class="input-field">
            <textarea id="nftDescription" placeholder="NFT Description" class="input-field" rows="3"></textarea>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">üí∞ Base Price (ETH)</label>
                    <input type="number" id="basePrice" placeholder="0.0" step="0.001" min="0" class="input-field">
                    <p id="priceRecommendation" class="text-sm text-purple-600"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ü§ù Royalty Split</label>
                    <div class="flex gap-2">
                        <input type="text" id="collaboratorAddress" placeholder="Collaborator Address (0x...)"
                            class="input-field flex-grow">
                        <input type="number" id="royaltyPercentage" placeholder="%" min="0" max="100"
                            class="input-field w-24">
                    </div>
                </div>
            </div>

            <button onclick="mintNFT()" id="mintBtn" class="btn-primary w-full" disabled>
                Mint NFT (Gasless)
            </button>
        </div>

        <!-- Transaction Status -->
        <div class="card" id="transactionStatus" style="display: none;">
            <h2 class="text-xl font-bold mb-4">üìä Transaction Status</h2>
            <div id="statusText" class="text-gray-600"></div>
            <div id="transactionHash" class="text-sm text-blue-600 mt-2"></div>
        </div>
    </main>

    <script type="module">
        import { createSmartAccountClient, PaymasterMode } from 'https://cdn.jsdelivr.net/npm/@0xgasless/smart-account@0.0.11/+esm';

        const CONFIG = {
            rpcUrl: "https://avax-mainnet.g.alchemy.com/v2/VcifYAbO7TUL14eUvHmbjSklgVzWEMXk",
            bundlerUrl: "https://bundler.0xgasless.com/43114",
            paymasterUrl: "https://paymaster.0xgasless.com/v1/43114/rpc/35b99953-edde-4f28-9661-c41898916471",
            chainId: 43114,
            nftContractAddress: "0xe7337B97F380A19A860068f0dACa74F50AF86548"
        };

        let smartWallet;
        let provider;
        let wallet;

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('privateKey').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    importWalletFromKey(e.target.value);
                }
            });
        });

        window.createNewWallet = async function () {
            try {
                const createWalletBtn = document.getElementById('createWalletBtn');
                const importWalletBtn = document.getElementById('importWalletBtn');
                const setupBtn = document.getElementById('setupBtn');

                createWalletBtn.disabled = true;
                importWalletBtn.disabled = true;

                provider = new ethers.providers.JsonRpcProvider(CONFIG.rpcUrl);
                wallet = ethers.Wallet.createRandom().connect(provider);

                document.getElementById('walletDetails').innerHTML = `
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p><strong>EOA Address:</strong> ${wallet.address}</p>
                        <p><strong>Private Key:</strong> ${wallet.privateKey}</p>
                        <p class="text-red-500 font-bold mt-2">‚ö†Ô∏è Save this private key securely!</p>
                    </div>
                `;

                setupBtn.disabled = false;
                createWalletBtn.disabled = false;
                importWalletBtn.disabled = false;
            } catch (error) {
                alert(`Error creating wallet: ${error.message}`);
                createWalletBtn.disabled = false;
                importWalletBtn.disabled = false;
            }
        };

        window.importWallet = function () {
            const privateKeyInput = document.getElementById('privateKey');
            privateKeyInput.style.display = privateKeyInput.style.display === 'none' ? 'block' : 'none';
            if (privateKeyInput.style.display === 'block') {
                privateKeyInput.focus();
            }
        };

        async function importWalletFromKey(privateKey) {
            try {
                if (!privateKey.startsWith('0x')) {
                    throw new Error('Private key must start with 0x');
                }

                provider = new ethers.providers.JsonRpcProvider(CONFIG.rpcUrl);
                wallet = new ethers.Wallet(privateKey, provider);

                document.getElementById('walletDetails').innerHTML = `
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p><strong>EOA Address:</strong> ${wallet.address}</p>
                        <p><strong>Status:</strong> Wallet imported successfully!</p>
                    </div>
                `;
                document.getElementById('setupBtn').disabled = false;
                document.getElementById('privateKey').style.display = 'none';
                document.getElementById('mintBtn').disabled = false;
            } catch (error) {
                alert(`Error importing wallet: ${error.message}`);
            }
        }

        window.setupSmartAccount = async function () {
            try {
                const setupBtn = document.getElementById('setupBtn');
                setupBtn.disabled = true;

                smartWallet = await createSmartAccountClient({
                    signer: wallet,
                    paymasterUrl: CONFIG.paymasterUrl,
                    bundlerUrl: CONFIG.bundlerUrl,
                    chainId: CONFIG.chainId
                });

                const address = await smartWallet.getAddress();
                document.getElementById('smartAccountInfo').innerHTML = `
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p><strong>Smart Account Address:</strong> ${address}</p>
                        <p><strong>Status:</strong> Ready for transactions</p>
                    </div>
                `;

                // Show NFT creation sections after smart account setup
                document.getElementById('nftCreation').style.display = 'block';
                document.getElementById('nftDetails').style.display = 'block';

                setupBtn.disabled = true; // Keep disabled after setup
            } catch (error) {
                document.getElementById('smartAccountInfo').innerHTML = `
                    <div class="p-4 bg-red-50 rounded-lg text-red-600">
                        Error: ${error.message}
                    </div>
                `;
                setupBtn.disabled = false;
            }
        };

        window.generateArtwork = async function () {
            try {
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.disabled = true;

                const prompt = document.getElementById('promptInput').value;
                const style = document.getElementById('styleSelect').value;

                if (!prompt) {
                    throw new Error('Please enter a description for your artwork');
                }

                // Format the prompt based on the selected style
                const formattedPrompt = formatPrompt(prompt, style);

                // Call Stable Diffusion API
                const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': "Bearer sk-QhFQ7FeqUoebAzzAw1a9DdKN82UrFLSCv9PPrrGwT1rZ70mb",
                    },
                    body: JSON.stringify({
                        text_prompts: [
                            {
                                text: formattedPrompt,
                                weight: 1
                            }
                        ],
                        cfg_scale: 7,
                        height: 1024,
                        width: 1024,
                        samples: 1,
                        steps: 30,
                        style_preset: style.toLowerCase()
                    })
                });

                if (!response.ok) {
                    throw new Error(`Generation failed: ${response.statusText}`);
                }

                const responseData = await response.json();
                const imageBase64 = responseData.artifacts[0].base64;

                // Display the generated image
                document.getElementById('artworkPreview').src = `data:image/png;base64,${imageBase64}`;

                // Get AI-recommended price based on style and complexity
                const recommendedPrice = await getRecommendedPrice(prompt, style);
                document.getElementById('priceRecommendation').textContent =
                    `ü§ñ AI Recommended Price: ${recommendedPrice} ETH`;

                generateBtn.disabled = false;
            } catch (error) {
                alert(`Error generating artwork: ${error.message}`);
                document.getElementById('generateBtn').disabled = false;
            }
        };

        // Helper function to format prompts based on style
        function formatPrompt(prompt, style) {
            const stylePrompts = {
                'realistic': `ultra realistic photograph, professional photography, ${prompt}, 8k uhd, high detail`,
                'abstract': `abstract art style, modern art, ${prompt}, vibrant colors, artistic expression`,
                'digital': `digital art, concept art, ${prompt}, detailed, vibrant, high resolution`,
                '3d': `3D rendered art, octane render, ${prompt}, high detail, realistic lighting`,
                'pixel': `pixel art style, 16-bit, ${prompt}, retro gaming aesthetic`,
                'cartoon': `cartoon style, illustration, ${prompt}, vibrant colors, clean lines`
            };

            return stylePrompts[style.toLowerCase()] || prompt;
        }

        window.mintNFT = async function () {
            try {
                const mintBtn = document.getElementById('mintBtn');
                mintBtn.disabled = true;

                const name = document.getElementById('nftName').value;
                const description = document.getElementById('nftDescription').value;
                const price = document.getElementById('basePrice').value;
                const collaborator = document.getElementById('collaboratorAddress').value;
                const royalty = document.getElementById('royaltyPercentage').value;

                if (!name || !description || !price) {
                    throw new Error('Please fill in all required fields');
                }

                const statusDiv = document.getElementById('transactionStatus');
                statusDiv.style.display = 'block';
                document.getElementById('statusText').textContent = 'Preparing to mint NFT...';

                // Simulate NFT minting transaction
                const tx = {
                    to: CONFIG.nftContractAddress,
                    value: 0,
                    data: '0x' // NFT minting function call would go here
                };

                const userOpResponse = await smartWallet.sendTransaction(tx, {
                    paymasterServiceData: {
                        mode: PaymasterMode.SPONSORED
                    }
                });

                document.getElementById('statusText').textContent = 'Minting in progress...';
                document.getElementById('transactionHash').innerHTML = `
                    Transaction Hash: <a href="https://goerli.basescan.org/tx/${userOpResponse.hash}" 
                    target="_blank" class="underline">${userOpResponse.hash}</a>
                `;

                const receipt = await userOpResponse.wait();
                if (receipt.success) {
                    document.getElementById('statusText').innerHTML = `
                        <div class="text-green-600">
                            ‚úÖ NFT Minted Successfully!<br>
                            Name: ${name}<br>
                            Price: ${price} ETH<br>
                            ${collaborator ? `Collaborator: ${collaborator} (${royalty}%)` : ''}
                        </div>
                    `;
                } else {
                    throw new Error('Transaction failed');
                }

                mintBtn.disabled = false;
            } catch (error) {
                document.getElementById('statusText').innerHTML = `<div class="text-red-600">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                document.getElementById('mintBtn').disabled = false;
            }
        };

        // NFT Contract ABI
        const nftABI = [
            "function mint(string memory tokenURI) public returns (uint256)",
            "function setTokenURI(uint256 tokenId, string memory _tokenURI) public",
            "function setRoyalties(uint256 tokenId, address receiver, uint96 feeNumerator) public"
        ];

        // Helper function to validate Ethereum address
        function isValidAddress(address) {
            try {
                ethers.utils.getAddress(address);
                return true;
            } catch {
                return false;
            }
        }

        // Helper function to upload metadata to IPFS (simulated)
        async function uploadToIPFS(metadata) {
            // In a real implementation, you would upload to IPFS here
            // For now, we'll return a dummy IPFS hash
            return `ipfs://QmX${Math.random().toString(36).substring(2, 15)}`;
        }

        // Helper function to create metadata
        async function createNFTMetadata(name, description, imageUrl) {
            return {
                name,
                description,
                image: imageUrl,
                attributes: [
                    {
                        trait_type: "Generator",
                        value: "AI Art Creator v1.0"
                    },
                    {
                        trait_type: "Style",
                        value: document.getElementById('styleSelect').value
                    },
                    {
                        trait_type: "Creation Date",
                        value: new Date().toISOString()
                    }
                ]
            };
        }

        // Initialize price recommendation system
        async function getRecommendedPrice() {
            // In a real implementation, this would use AI to analyze similar NFTs
            // For now, we'll return a random price
            const basePrice = 0.05;
            const variance = Math.random() * 0.1 - 0.05;
            return (basePrice + variance).toFixed(3);
        }

        // Setup event listeners for input validation
        document.getElementById('collaboratorAddress').addEventListener('input', function (e) {
            const address = e.target.value;
            if (address && !isValidAddress(address)) {
                e.target.style.borderColor = '#ef4444';
            } else {
                e.target.style.borderColor = '#e5e7eb';
            }
        });

        document.getElementById('royaltyPercentage').addEventListener('input', function (e) {
            const value = parseFloat(e.target.value);
            if (isNaN(value) || value < 0 || value > 100) {
                e.target.style.borderColor = '#ef4444';
            } else {
                e.target.style.borderColor = '#e5e7eb';
            }
        });

        // Add loading indicators
        function setLoading(elementId, isLoading) {
            const element = document.getElementById(elementId);
            if (isLoading) {
                element.classList.add('loading');
            } else {
                element.classList.remove('loading');
            }
        }

        // Initialize tooltips
        const tooltips = document.querySelectorAll('[data-tooltip]');
        tooltips.forEach(element => {
            element.addEventListener('mouseenter', e => {
                const tooltip = document.createElement('div');
                tooltip.className = 'absolute bg-gray-800 text-white p-2 rounded text-sm';
                tooltip.textContent = e.target.dataset.tooltip;
                document.body.appendChild(tooltip);

                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.bottom + 5) + 'px';

                e.target.addEventListener('mouseleave', () => tooltip.remove());
            });
        });

    </script>

    <!-- Add a global error boundary -->
    <div id="errorBoundary"
        class="fixed bottom-4 right-4 max-w-sm bg-red-100 border-l-4 border-red-500 text-red-700 p-4"
        style="display: none;">
        <div class="flex">
            <div class="py-1">
                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm" id="errorMessage"></p>
            </div>
        </div>
    </div>

    <!-- Add a feedback widget -->
    <div class="fixed bottom-4 left-4">
        <button onclick="showFeedback()"
            class="bg-purple-600 text-white rounded-full p-3 shadow-lg hover:bg-purple-700 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
        </button>
    </div>

</body>

</html>